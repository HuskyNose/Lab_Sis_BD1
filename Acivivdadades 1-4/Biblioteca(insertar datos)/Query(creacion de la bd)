Biblioteca Query para la creacion de la estructura de la bd

CREATE TABLE AUTOR (
  ID            INTEGER PRIMARY KEY,
  NOMBRE        TEXT NOT NULL,
  NACIONALIDAD  TEXT,
  BIBLIOGRAFIA  TEXT,
  CREATED_AT    TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT    TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_autor_nombre ON AUTOR (NOMBRE);

CREATE TRIGGER trg_autor_updated_at
AFTER UPDATE ON AUTOR
FOR EACH ROW
BEGIN
  UPDATE AUTOR
  SET UPDATED_AT = CURRENT_TIMESTAMP
  WHERE ID = NEW.ID;
END;

CREATE TABLE EDITORIAL (
  ID          INTEGER PRIMARY KEY,
  NOMBRE      TEXT NOT NULL,
  DIRECCION   TEXT,
  TELEFONO    TEXT,
  EMAIL       TEXT,
  CREATED_AT  TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT  TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (NOMBRE)
);

CREATE TRIGGER trg_editorial_updated_at
AFTER UPDATE ON EDITORIAL
FOR EACH ROW
BEGIN
  UPDATE EDITORIAL
  SET UPDATED_AT = CURRENT_TIMESTAMP
  WHERE ID = NEW.ID;
END;

CREATE TABLE LIBRO (
  ID                INTEGER PRIMARY KEY,
  TITULO            TEXT NOT NULL,
  ISBN              TEXT,
  GENERO            TEXT,
  IDIOMA            TEXT,
  PAGINAS           INTEGER CHECK (PAGINAS IS NULL OR PAGINAS > 0),
  FECHA_PUBLICACION TEXT,
  DESCRIPCION       TEXT,
  CREATED_AT        TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT        TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (ISBN)
);

CREATE INDEX idx_libro_titulo ON LIBRO (TITULO);
CREATE INDEX idx_libro_genero ON LIBRO (GENERO);

CREATE TRIGGER trg_libro_updated_at
AFTER UPDATE ON LIBRO
FOR EACH ROW
BEGIN
  UPDATE LIBRO
  SET UPDATED_AT = CURRENT_TIMESTAMP
  WHERE ID = NEW.ID;
END;

CREATE TABLE USUARIO (
  ID             INTEGER PRIMARY KEY,
  NOMBRE         TEXT NOT NULL,
  EMAIL          TEXT,
  TELEFONO       TEXT,
  DIRECCION      TEXT,
  TIPO           TEXT NOT NULL DEFAULT 'alumno'
    CHECK (TIPO IN ('alumno','docente','externo','admin')),
  ACTIVO         INTEGER NOT NULL DEFAULT 1 CHECK (ACTIVO IN (0,1)),
  FECHA_REGISTRO TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT     TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UNIQUE (EMAIL)
);

CREATE INDEX idx_usuario_nombre ON USUARIO (NOMBRE);
CREATE INDEX idx_usuario_tipo   ON USUARIO (TIPO);

CREATE TRIGGER trg_usuario_updated_at
AFTER UPDATE ON USUARIO
FOR EACH ROW
BEGIN
  UPDATE USUARIO
  SET UPDATED_AT = CURRENT_TIMESTAMP
  WHERE ID = NEW.ID;
END;

CREATE TABLE LIBRO_AUTOR (
  LIBRO_ID       INTEGER NOT NULL,
  AUTOR_ID       INTEGER NOT NULL,
  ORDEN_AUTORIA  INTEGER CHECK (ORDEN_AUTORIA IS NULL OR ORDEN_AUTORIA > 0),
  ROL            TEXT,
  PRIMARY KEY (LIBRO_ID, AUTOR_ID),
  FOREIGN KEY (LIBRO_ID) REFERENCES LIBRO(ID)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (AUTOR_ID) REFERENCES AUTOR(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT
) WITHOUT ROWID;

CREATE INDEX idx_libro_autor_autor ON LIBRO_AUTOR (AUTOR_ID);

CREATE TABLE EDICION (
  ID                INTEGER PRIMARY KEY,
  LIBRO_ID          INTEGER NOT NULL,
  EDITORIAL_ID      INTEGER NOT NULL,
  NUM_EDICION       INTEGER CHECK (NUM_EDICION IS NULL OR NUM_EDICION > 0),
  FECHA_LANZAMIENTO TEXT,
  LUGAR_PUBLICACION TEXT,
  ISBN_EDICION      TEXT,
  CREATED_AT        TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  UPDATED_AT        TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (LIBRO_ID) REFERENCES LIBRO(ID)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (EDITORIAL_ID) REFERENCES EDITORIAL(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT,

  UNIQUE (LIBRO_ID, EDITORIAL_ID, NUM_EDICION, FECHA_LANZAMIENTO),
  UNIQUE (ISBN_EDICION)
);

CREATE INDEX idx_edicion_libro ON EDICION (LIBRO_ID);
CREATE INDEX idx_edicion_editorial ON EDICION (EDITORIAL_ID);

CREATE TRIGGER trg_edicion_updated_at
AFTER UPDATE ON EDICION
FOR EACH ROW
BEGIN
  UPDATE EDICION
  SET UPDATED_AT = CURRENT_TIMESTAMP
  WHERE ID = NEW.ID;
END;

CREATE TABLE EJEMPLAR (
  ID            INTEGER PRIMARY KEY,
  EDICION_ID    INTEGER NOT NULL,
  CODIGO_BARRAS TEXT NOT NULL,
  UBICACION     TEXT,
  ESTADO        TEXT NOT NULL DEFAULT 'disponible'
    CHECK (ESTADO IN ('disponible','prestado','reservado','mantenimiento','baja')),
  FECHA_ALTA    TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,

  FOREIGN KEY (EDICION_ID) REFERENCES EDICION(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT,

  UNIQUE (CODIGO_BARRAS)
);

CREATE INDEX idx_ejemplar_edicion ON EJEMPLAR (EDICION_ID);
CREATE INDEX idx_ejemplar_estado  ON EJEMPLAR (ESTADO);

CREATE TABLE PRESTAMO (
  ID             INTEGER PRIMARY KEY,
  USUARIO_ID     INTEGER NOT NULL,
  FECHA_PRESTAMO TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  ESTADO         TEXT NOT NULL DEFAULT 'activo'
    CHECK (ESTADO IN ('activo','cerrado','cancelado')),
  OBSERVACIONES  TEXT,

  FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_prestamo_usuario ON PRESTAMO (USUARIO_ID);
CREATE INDEX idx_prestamo_estado  ON PRESTAMO (ESTADO);

CREATE TABLE PRESTAMO_ITEM (
  PRESTAMO_ID         INTEGER NOT NULL,
  EJEMPLAR_ID         INTEGER NOT NULL,
  FECHA_VENCIMIENTO   TEXT NOT NULL,
  FECHA_DEVOLUCION    TEXT,
  ESTADO              TEXT NOT NULL DEFAULT 'activo'
    CHECK (ESTADO IN ('activo','devuelto','atrasado')),
  CONDICION_DEVOLUCION TEXT,
  MULTA_MXN            REAL NOT NULL DEFAULT 0 CHECK (MULTA_MXN >= 0),

  PRIMARY KEY (PRESTAMO_ID, EJEMPLAR_ID),

  FOREIGN KEY (PRESTAMO_ID) REFERENCES PRESTAMO(ID)
    ON UPDATE CASCADE ON DELETE CASCADE,
  FOREIGN KEY (EJEMPLAR_ID) REFERENCES EJEMPLAR(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT
) WITHOUT ROWID;

CREATE INDEX idx_prestamo_item_ejemplar ON PRESTAMO_ITEM (EJEMPLAR_ID);
CREATE INDEX idx_prestamo_item_estado   ON PRESTAMO_ITEM (ESTADO);

-- Evita 2 pr√©stamos activos del mismo ejemplar
CREATE UNIQUE INDEX uq_ejemplar_prestamo_activo
ON PRESTAMO_ITEM (EJEMPLAR_ID)
WHERE ESTADO = 'activo';

CREATE TABLE RESERVA (
  ID            INTEGER PRIMARY KEY,
  USUARIO_ID    INTEGER NOT NULL,
  LIBRO_ID      INTEGER NOT NULL,
  FECHA_RESERVA TEXT NOT NULL DEFAULT CURRENT_TIMESTAMP,
  EXPIRA_EN     TEXT,
  ESTADO        TEXT NOT NULL DEFAULT 'activa'
    CHECK (ESTADO IN ('activa','cancelada','cumplida','expirada')),

  FOREIGN KEY (USUARIO_ID) REFERENCES USUARIO(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT,
  FOREIGN KEY (LIBRO_ID) REFERENCES LIBRO(ID)
    ON UPDATE CASCADE ON DELETE RESTRICT
);

CREATE INDEX idx_reserva_usuario ON RESERVA (USUARIO_ID);
CREATE INDEX idx_reserva_libro   ON RESERVA (LIBRO_ID);
CREATE INDEX idx_reserva_estado  ON RESERVA (ESTADO);

CREATE UNIQUE INDEX uq_reserva_activa_usuario_libro
ON RESERVA (USUARIO_ID, LIBRO_ID)
WHERE ESTADO = 'activa';